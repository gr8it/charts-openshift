suite: APC global overrides - local values only
templates:
  - templates/apc-global-overrides.yaml
values:
  - ../values.local.yaml
release:
  name: agout
  namespace: default

tests:
  - it: manifest should match snapshot
    asserts:
      - matchSnapshot: {}

  - it: customer from local
    asserts:
      - equal: { path: data.customer, value: customer-local }

  - it: repo fields from local
    asserts:
      - equal: { path: data.repoURL, value: repoURL-local }
      - equal: { path: data.repoTargetRevision, value: repoTargetRevision-local }

  - it: environment fields from local
    asserts:
      - equal: { path: data.environment, value: environment-local }
      - equal: { path: data.environmentShort, value: environmentShort-local }

  - it: cluster identity fields from local
    asserts:
      - equal: { path: data.clusterName, value: clusterName-local }
      - equal: { path: data.clusterAcmName, value: clusterAcmName-local }
      - equal: { path: data.clusterType, value: clusterType-local }

  - it: cluster domain and API fields from local
    asserts:
      - equal: { path: data.clusterBaseDomain, value: clusterBaseDomain-local }
      - equal: { path: data.clusterAppsDomain, value: clusterAppsDomain-local }
      - equal: { path: data.clusterApiURL, value: clusterApiURL-local }

  - it: cluster API versions from local
    asserts:
      - equal: { path: data.clusterKubeVersion, value: clusterKubeVersion-local }
      - equal:
          path: data.clusterApiVersions
          value:
            - clusterApiVersions-local

  - it: clusterServices and merged (local only, no global keys in non-merged)
    asserts:
      - equal: { path: data.clusterServices.local.url, value: clusterServicesLocalUrl-local }
      - equal: { path: data.clusterServices.override.url, value: clusterServicesOverrideUrl-local }
      - notExists: { path: data.clusterServices.global }
      - equal: { path: data.clusterServicesMerged.local.url, value: clusterServicesLocalUrl-local }
      - equal: { path: data.clusterServicesMerged.override.url, value: clusterServicesOverrideUrl-local }
      - notExists: { path: data.clusterServicesMerged.global }

  - it: booleans from local
    asserts:
      - equal: { path: data.clusterIsHub, value: false }
      - equal: { path: data.clusterRunsApps, value: false }

  - it: proxy, noProxy, proxyCIDRs from local
    asserts:
      - equal: { path: data.proxy, value: proxy-local }
      - equal: { path: data.noProxy, value: noProxy-local }
      - equal:
          path: data.proxyCIDRs
          value:
            - proxyIP-local1
            - proxyIP-local2

  - it: services and merged (local only, no global keys in non-merged)
    asserts:
      - equal: { path: data.services.local.url, value: servicesLocaltUrl-local }
      - notExists: { path: data.services.global }
      - equal: { path: data.servicesMerged.local.url, value: servicesLocaltUrl-local }
      - notExists: { path: data.servicesMerged.global }
      - equal: { path: data.servicesExtracted.certManager.defaultClusterIssuer, value: certManagerDefaultClusterIssuer-local }
      - equal: { path: data.servicesExtracted.crossplane.kubeVaultProviderConfigName, value: crossplaneKubeVaultProviderConfigName-local }
      - equal: { path: data.servicesExtracted.externalSecretsOperator.defaultClusterSecretStore, value: ESODefaultClusterSecretStore-local }
      - equal: { path: data.servicesExtracted.vault.kubeAuthMountPath, value: vaultKubeAuthMountPath-local }
      - equal: { path: data.servicesExtracted.vault.name, value: vaultName-local }
      - equal: { path: data.servicesExtracted.vault.url, value: vaultUrl-local }

  - it: caCertificates and merged (local only, no global keys in non-merged)
    asserts:
      - equal:
          path: data.caCertificates["override.crt"]
          value: |
            -----BEGIN CERTIFICATE-----
            local
            -----END CERTIFICATE-----
      - equal:
          path: data.caCertificates["local.crt"]
          value: |
            -----BEGIN CERTIFICATE-----
            local
            -----END CERTIFICATE-----
      - notExists:
          path: data.caCertificates["global.crt"]
      - equal:
          path: data.caCertificatesMerged["override.crt"]
          value: |
            -----BEGIN CERTIFICATE-----
            local
            -----END CERTIFICATE-----
      - equal:
          path: data.caCertificatesMerged["local.crt"]
          value: |
            -----BEGIN CERTIFICATE-----
            local
            -----END CERTIFICATE-----
