manifests should match snapshot:
  1: |
    apiVersion: rbac.authorization.k8s.io/v1
    kind: ClusterRole
    metadata:
      labels:
        rbac.authorization.k8s.io/aggregate-to-apc-project-operator: "true"
      name: microservice-project-operator
    rules:
      - apiGroups:
          - ck.socpoist.sk
        resources:
          - microservices
        verbs:
          - '*'
      - apiGroups:
          - ck.socpoist.sk
        resources:
          - microserviceaccess
        verbs:
          - '*'
  2: |
    apiVersion: rbac.authorization.k8s.io/v1
    kind: ClusterRole
    metadata:
      labels:
        rbac.authorization.k8s.io/aggregate-to-apc-project-admin: "true"
      name: microservice-project-admin
    rules:
      - apiGroups:
          - ck.socpoist.sk
        resources:
          - microservices
        verbs:
          - '*'
      - apiGroups:
          - ck.socpoist.sk
        resources:
          - microserviceaccess
        verbs:
          - '*'
  3: |
    apiVersion: apiextensions.crossplane.io/v1
    kind: Composition
    metadata:
      name: ck-microservice
    spec:
      compositeTypeRef:
        apiVersion: ck.socpoist.sk/v1alpha1
        kind: microservice
      mode: Pipeline
      pipeline:
        - functionRef:
            name: function-go-templating
          input:
            apiVersion: gotemplating.fn.crossplane.io/v1beta1
            inline:
              template: |
                apiVersion: openidclient.keycloak.m.crossplane.io/v1alpha1
                kind: Client
                metadata:
                  name: {{ .observed.composite.resource.metadata.name }}
                spec:
                  deletionPolicy: Delete
                  forProvider:
                    realmId: apps
                    clientId: {{ .observed.composite.resource.metadata.name }}
                    name: {{ .observed.composite.resource.metadata.name }}
                    description: {{ .observed.composite.resource.metadata.name }} mikrosluzba
                    accessType: BEARER-ONLY
                    frontchannelLogoutEnabled: true
                  providerConfigRef:
                    name: keycloak-local-config
            kind: GoTemplate
            source: Inline
          step: microservice-client
        - functionRef:
            name: function-go-templating
          input:
            apiVersion: gotemplating.fn.crossplane.io/v1beta1
            inline:
              template: |
                {{- range .observed.composite.resource.spec.roles }}
                apiVersion: role.keycloak.m.crossplane.io/v1alpha1
                kind: Role
                metadata:
                  name: {{ .observed.composite.resource.metadata.name }}-{{ . }}
                spec:
                  deletionPolicy: Delete
                  forProvider:
                    realmId: apps
                    name: {{ . }}
                    clientIdRef:
                      name: {{ .observed.composite.resource.metadata.name }}
                  providerConfigRef:
                    name: keycloak-local-config
                ---
                {{- end }}
            kind: GoTemplate
            source: Inline
          step: microservice-clientroles
        - functionRef:
            name: function-go-templating
          input:
            apiVersion: gotemplating.fn.crossplane.io/v1beta1
            inline:
              template: |
                {{- range .observed.composite.resource.spec.roles }}
                apiVersion: group.keycloak.m.crossplane.io/v1alpha1
                kind: Group
                metadata:
                  name: apc--ck-{{ .observed.composite.resource.metadata.name }}-{{ . }}
                spec:
                  managementPolicies: ["Observe"]
                  forProvider:
                    realmId: apps
                    name: APC--CK-{{ .observed.composite.resource.metadata.name | upper }}-{{ . | upper }}
                  providerConfigRef:
                    name: keycloak-local-config
                ---
                {{- end }}
            kind: GoTemplate
            source: Inline
          step: microservice-groups
        - functionRef:
            name: function-go-templating
          input:
            apiVersion: gotemplating.fn.crossplane.io/v1beta1
            inline:
              template: |
                {{- range .observed.composite.resource.spec.roles }}
                apiVersion: group.keycloak.m.crossplane.io/v1alpha1
                kind: Roles
                metadata:
                  name: apc--ck-{{ .observed.composite.resource.metadata.name }}-{{ . }}
                spec:
                  deletionPolicy: Delete
                  forProvider:
                    realmId: apps
                    groupIdRef:
                      name: apc--ck-{{ .observed.composite.resource.metadata.name }}-{{ . }}
                    roleIdsRefs:
                    - name: {{ .observed.composite.resource.metadata.name }}-admin
                    # not gitopsy!
                    exhaustive: false
                  providerConfigRef:
                    name: keycloak-local-config
                ---
                {{- end }}
            kind: GoTemplate
            source: Inline
          step: microservice-group-roles
        - functionRef:
            name: function-go-templating
          input:
            apiVersion: gotemplating.fn.crossplane.io/v1beta1
            inline:
              template: |
                apiVersion: openidclient.keycloak.m.crossplane.io/v1alpha1
                kind: Client
                metadata:
                  name: {{ .observed.composite.resource.metadata.name }}-admin
                spec:
                  deletionPolicy: Delete
                  forProvider:
                    realmId: apps
                    clientId: {{ .observed.composite.resource.metadata.name }}-admin
                    name: {{ .observed.composite.resource.metadata.name }}-admin
                    description: {{ .observed.composite.resource.metadata.name }} admin mikrosluzba
                    accessType: PUBLIC
                    standardFlowEnabled: true
                    {{- if or .observed.composite.resource.spec.rootUrl .observed.composite.resource.spec.baseUrl }}
                    rootUrl: {{ .observed.composite.resource.spec.rootUrl | default .observed.composite.resource.spec.baseUrl }}
                    {{- end }}
                    {{- if .observed.composite.resource.spec.baseUrl }}
                    baseUrl: {{ default .observed.composite.resource.spec.baseUrl }}
                    {{- end }}
                    validRedirectUris:
                      {{- range .observed.composite.resource.spec.validRedirectUris }}
                      - {{ . }}
                      {{- end }}
                    {{- if .observed.composite.resource.spec.webOrigins }}
                    webOrigins:
                      {{- range .observed.composite.resource.spec.webOrigins }}
                      - {{ . }}
                      {{- end }}
                    {{- end }}
                    frontchannelLogoutEnabled: true
                    pkceCodeChallengeMethod: S256
                    fullScopeAllowed: false
                  providerConfigRef:
                    name: keycloak-local-config
            kind: GoTemplate
            source: Inline
          step: microservice-admin-client
        - functionRef:
            name: function-go-templating
          input:
            apiVersion: gotemplating.fn.crossplane.io/v1beta1
            inline:
              template: |
                {{- range .observed.composite.resource.spec.roles }}
                apiVersion: client.keycloak.m.crossplane.io/v1alpha1
                kind: RoleMapper
                metadata:
                  name: {{ .observed.composite.resource.metadata.name }}-admin-{{ .observed.composite.resource.metadata.name }}-{{ . }}
                spec:
                  deletionPolicy: Delete
                  forProvider:
                    realmId: apps
                    clientIdRef:
                      name: {{ .observed.composite.resource.metadata.name }}-admin
                    roleIdRef:
                      name: {{ .observed.composite.resource.metadata.name }}-{{ . }}
                  providerConfigRef:
                    name: keycloak-local-config
                ---
                {{- end }}
            kind: GoTemplate
            source: Inline
          step: microservice-admin-rolemappers
        - functionRef:
            name: function-go-templating
          input:
            apiVersion: gotemplating.fn.crossplane.io/v1beta1
            inline:
              template: |
                apiVersion: client.keycloak.m.crossplane.io/v1alpha1
                kind: ProtocolMapper
                metadata:
                  name: {{ .observed.composite.resource.metadata.name }}-admin-audience-{{ .observed.composite.resource.metadata.name }}
                spec:
                  deletionPolicy: Delete
                  forProvider:
                    realmId: apps
                    clientIdRef:
                      name: {{ .observed.composite.resource.metadata.name }}-admin
                    protocol: openid-connect
                    protocolMapper: oidc-audience-mapper
                    name: add {{ .observed.composite.resource.metadata.name }} audience
                    # https://github.com/keycloak/keycloak/blob/0f01444543cf5e755b13a62c233a5c9feef72888/services/src/main/java/org/keycloak/protocol/oidc/mappers/OIDCAttributeMapperHelper.java#L60
                    config:
                      "included.client.audience": "{{ .observed.composite.resource.metadata.name }}"
                      "access.token.claim": "true"
                      "introspection.token.claim": "true"
                  providerConfigRef:
                    name: keycloak-local-config
            kind: GoTemplate
            source: Inline
          step: microservice-admin-protocolmapper
        - functionRef:
            name: function-go-templating
          input:
            apiVersion: gotemplating.fn.crossplane.io/v1beta1
            inline:
              template: |
                apiVersion: openidclient.keycloak.m.crossplane.io/v1alpha1
                kind: Client
                metadata:
                  name: bamoe-management-console
                spec:
                  managementPolicies: ["Observe"]
                  forProvider:
                    realmId: apps
                    clientId: bamoe-management-console
                  providerConfigRef:
                    name: keycloak-local-config
            kind: GoTemplate
            source: Inline
          step: bamoe-client
        - functionRef:
            name: function-go-templating
          input:
            apiVersion: gotemplating.fn.crossplane.io/v1beta1
            inline:
              template: |
                {{- range .observed.composite.resource.spec.roles }}
                apiVersion: client.keycloak.m.crossplane.io/v1alpha1
                kind: RoleMapper
                metadata:
                  name: bamoe-{{ .observed.composite.resource.metadata.name }}-{{ . }}
                spec:
                  deletionPolicy: Delete
                  forProvider:
                    realmId: apps
                    clientIdRef:
                      name: bamoe-management-console
                    roleIdRef:
                      name: {{ .observed.composite.resource.metadata.name }}-{{ . }}
                  providerConfigRef:
                    name: keycloak-local-config
                ---
                {{- end }}
            kind: GoTemplate
            source: Inline
          step: bamoe-rolemappers
        - functionRef:
            name: function-go-templating
          input:
            apiVersion: gotemplating.fn.crossplane.io/v1beta1
            inline:
              template: |
                apiVersion: client.keycloak.m.crossplane.io/v1alpha1
                kind: ProtocolMapper
                metadata:
                  name: bamoe-audience-{{ .observed.composite.resource.metadata.name }}
                spec:
                  deletionPolicy: Delete
                  forProvider:
                    realmId: apps
                    clientIdRef:
                      name: bamoe-management-console
                    protocol: openid-connect
                    protocolMapper: oidc-audience-mapper
                    name: add {{ .observed.composite.resource.metadata.name }} audience
                    # https://github.com/keycloak/keycloak/blob/0f01444543cf5e755b13a62c233a5c9feef72888/services/src/main/java/org/keycloak/protocol/oidc/mappers/OIDCAttributeMapperHelper.java#L60
                    config:
                      "included.client.audience": "{{ .observed.composite.resource.metadata.name }}"
                      "access.token.claim": "true"
                      "introspection.token.claim": "true"
                  providerConfigRef:
                    name: keycloak-local-config
            kind: GoTemplate
            source: Inline
          step: bamoe-protolmapper
        - functionRef:
            name: function-auto-ready
          step: automatically-detect-readiness
  4: |
    apiVersion: apiextensions.crossplane.io/v1
    kind: Composition
    metadata:
      name: ck-microservice-access
    spec:
      compositeTypeRef:
        apiVersion: ck.socpoist.sk/v1alpha1
        kind: microserviceaccess
      mode: Pipeline
      pipeline:
        - functionRef:
            name: function-go-templating
          input:
            apiVersion: gotemplating.fn.crossplane.io/v1beta1
            inline:
              template: |
                apiVersion: openidclient.keycloak.m.crossplane.io/v1alpha1
                kind: Client
                metadata:
                  name: {{ .observed.composite.resource.metadata.name }}
                spec:
                  managementPolicies: ["Observe"]
                  forProvider:
                    realmId: apps
                    clientId: {{ .observed.composite.resource.metadata.name }}
                  providerConfigRef:
                    name: keycloak-local-config
            kind: GoTemplate
            source: Inline
          step: isas-client
        - functionRef:
            name: function-go-templating
          input:
            apiVersion: gotemplating.fn.crossplane.io/v1beta1
            inline:
              template: |
                apiVersion: client.keycloak.m.crossplane.io/v1alpha1
                kind: RoleMapper
                metadata:
                  name: {{ .observed.composite.resource.metadata.name }}-{{ .observed.composite.resource.spec.clientId }}-{{ .observed.composite.resource.spec.clientRole }}
                spec:
                  deletionPolicy: Delete
                  forProvider:
                    realmId: apps
                    clientIdRef:
                      name: {{ .observed.composite.resource.metadata.name }}
                    roleIdRef:
                      name: {{ .observed.composite.resource.spec.clientId }}-{{ .observed.composite.resource.spec.clientRole }}
                  providerConfigRef:
                    name: keycloak-local-config
            kind: GoTemplate
            source: Inline
          step: isas-rolemapper
        - functionRef:
            name: function-go-templating
          input:
            apiVersion: gotemplating.fn.crossplane.io/v1beta1
            inline:
              template: |
                apiVersion: client.keycloak.m.crossplane.io/v1alpha1
                kind: ProtocolMapper
                metadata:
                  name: {{ .observed.composite.resource.metadata.name }}-audience-{{ .observed.composite.resource.spec.clientId }}
                spec:
                  deletionPolicy: Delete
                  forProvider:
                    realmId: apps
                    clientIdRef:
                      name: {{ .observed.composite.resource.metadata.name }}
                    protocol: openid-connect
                    protocolMapper: oidc-audience-mapper
                    name: add {{ .observed.composite.resource.metadata.clientId }} audience
                    # https://github.com/keycloak/keycloak/blob/0f01444543cf5e755b13a62c233a5c9feef72888/services/src/main/java/org/keycloak/protocol/oidc/mappers/OIDCAttributeMapperHelper.java#L60
                    config:
                      "included.client.audience": "{{ .observed.composite.resource.spec.clientId }}"
                      "access.token.claim": "true"
                      "introspection.token.claim": "true"
                  providerConfigRef:
                    name: keycloak-local-config
            kind: GoTemplate
            source: Inline
          step: microservice-admin-protocolmapper
        - functionRef:
            name: function-go-templating
          input:
            apiVersion: gotemplating.fn.crossplane.io/v1beta1
            inline:
              template: |
                apiVersion: openidclient.keycloak.crossplane.io/v1alpha1
                kind: ClientServiceAccountRole
                metadata:
                  name: {{ .observed.composite.resource.metadata.name }}-{{ .observed.composite.resource.spec.clientId }}-{{ .observed.composite.resource.spec.clientRole }}
                spec:
                  deletionPolicy: Delete
                  forProvider:
                    realmId: apps
                    serviceAccountUserClientIdRef:
                      name: {{ .observed.composite.resource.metadata.name }}
                    clientIdRef:
                      name: {{ .observed.composite.resource.spec.clientId }}
                    role: {{ .observed.composite.resource.spec.clientRole }}
                  providerConfigRef:
                    name: keycloak-local-config
            kind: GoTemplate
            source: Inline
          step: bamoe-client
        - functionRef:
            name: function-auto-ready
          step: automatically-detect-readiness
  5: |
    apiVersion: ck.socpoist.sk/v1alpha1
    kind: microservice
    metadata:
      name: bpm
      namespace: default
    spec:
      baseUrl: https://bpm-test-prime.apps.s1.lab.sp.gr8it.cloud
      roles:
        - admin
        - worker
        - reader
      rootUrl: https://bpm-test-prime.apps.s1.lab.sp.gr8it.cloud/admin/processes
      validRedirectUris:
        - https://bpm-test-prime.apps.s1.lab.sp.gr8it.cloud/admin/q/oidc/callback
      webOrigins:
        - https://bpm-test-prime.apps.s1.lab.sp.gr8it.cloud/admin/processes
  6: |
    apiVersion: ck.socpoist.sk/v1alpha1
    kind: microserviceaccess
    metadata:
      name: isas
      namespace: default
    spec:
      clientId: bpm
      clientRole: reader
  7: |
    apiVersion: apiextensions.crossplane.io/v2
    kind: CompositeResourceDefinition
    metadata:
      name: microserviceaccesses.ck.socpoist.sk
    spec:
      group: ck.socpoist.sk
      names:
        kind: Microserviceaccess
        plural: microserviceaccesses
      scope: Namespaced
      versions:
        - name: v1alpha1
          referenceable: true
          schema:
            openAPIV3Schema: |-
              type: object
              properties:
                spec:
                  type: object
                  description: Defines access to a microservice
                  properties:
                    clientId:
                      type: string
                      description: Keycloak client name to assume the role for
                    clientRole:
                      type: string
                      description: 'Client role to assume for the microservice access client '
                  required:
                    - clientRole
                    - clientId
              required:
                - spec
          served: true
  8: |
    apiVersion: apiextensions.crossplane.io/v2
    kind: CompositeResourceDefinition
    metadata:
      name: microservices.ck.socpoist.sk
    spec:
      group: ck.socpoist.sk
      names:
        kind: Microservice
        plural: microservices
      scope: Namespaced
      versions:
        - name: v1alpha1
          referenceable: true
          schema:
            openAPIV3Schema: |-
              type: object
              properties:
                spec:
                  type: object
                  description: Defines the microservice
                  properties:
                    roles:
                      type: array
                      description: List of microservice Keycloak roles
                    validRedirectUris:
                      type: array
                      description: List of Keycloak client allowed redirect URIs
                    webOrigins:
                      type: array
                      description: List of Keycloak client allowed web origins, allowed CORS origins. To permit all origins of Valid Redirect URIs, add '+'. This does not include the '*' wildcard though. To permit all origins, explicitly add '*'.
                    rootUrl:
                      type: string
                      description: Root URL of the microservice Keycloak client, prepended to all relative URLs
                    baseUrl:
                      type: string
                      description: Base URL of the microservice Keycloak client, used as a default redirect
                  required:
                    - roles
                    - validRedirectUris
              required:
                - spec
          served: true
