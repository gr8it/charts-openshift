apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ include "apc-global-overrides.crossplaneKubeKeycloakProviderConfigName" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "crossplane-keycloak-provider-bootstrap.labels" . | nindent 4 }}
spec:
  refreshInterval: 1h # default 1h
  secretStoreRef:
    name: vault-hub-secret-store
    kind: ClusterSecretStore
  target:
    name: pull-secret
    creationPolicy: Owner
    template:
      labels:
        type: provider-credentials
      data:
        config.json: |
          {
            "client_id":"admin-cli",
            "username": "{{`{{ .username }}`}}",
            "password": "{{`{{ .password }}`}}",
            "url": "{{ include "apc-global-overrides.keycloakUrl" . }}",
            "base_path": "",
            "realm": "{{ include "apc-global-overrides.keycloakRealm" . }}",
            "tls_insecure_skip_verify": "false",
            "root_ca_certificate": "/certs/ca-bundle.crt"
          }
  data:
  - secretKey: username
    remoteRef:
      key: {{ include "apc-global.overrides.vaultKVmountPlatform" . }}/{{ include "apc-global-overrides.environmentShort" }}/keycloak
      property: username
  - secretKey: password
    remoteRef:
      key: {{ include "apc-global.overrides.vaultKVmountPlatform" . }}/{{ include "apc-global-overrides.environmentShort" }}/keycloak
      property: password
