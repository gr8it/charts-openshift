# Stackrox namespace configuration
stackrox:
  namespace: stackrox

# SecuredCluster configuration
securedCluster:
  name: stackrox-secured-cluster-services
  clusterName: dev01  # Override this per environment
  centralEndpoint: 'https://central-stackrox.apps.hub01.cloud.socpoist.sk:443'
  
  admissionControl:
    bypass: BreakGlassAnnotation
    contactImageScanners: DoNotScanInline
    listenOnCreates: true
    listenOnEvents: true
    listenOnUpdates: true
    replicas: 3
    timeoutSeconds: 10
  
  auditLogs:
    collection: Auto
  
  monitoring:
    openshift:
      enabled: true
  
  network:
    policies: Enabled
  
  perNode:
    collector:
      collection: CORE_BPF
      forceCollection: false
      imageFlavor: Regular
    taintToleration: TolerateTaints
  
  sensor:
    resources:
      limits:
        cpu: '2'
        memory: 4Gi
      requests:
        cpu: '500m'
        memory: 1Gi
  
  scanner:
    analyzer:
      scaling:
        autoScaling: Enabled
        maxReplicas: 5
        minReplicas: 2
        replicas: 3
      resources:
        limits:
          cpu: '2'
          memory: 4Gi
        requests:
          cpu: '200m'
          memory: 512Mi
    scannerComponent: AutoSense
  
  scannerV4:
    db:
      persistence:
        persistentVolumeClaim:
          claimName: scanner-v4-db
      resources:
        limits:
          cpu: '2'
          memory: 4Gi
        requests:
          cpu: '200m'
          memory: 512Mi
    indexer:
      scaling:
        autoScaling: Enabled
        maxReplicas: 5
        minReplicas: 2
        replicas: 3
    scannerComponent: Default

# Central configuration (enable for hub clusters)
central:
  enabled: false
  name: stackrox-central-services
  namespace: "" # Defaults to stackrox namespace
  spec:
    central:
      resources:
        limits:
          cpu: '4'
          memory: 8Gi
        requests:
          cpu: '500m'
          memory: 2Gi
      db:
        isEnabled: Default
        persistence:
          persistentVolumeClaim:
            claimName: central-db
        resources:
          limits:
            cpu: '8'
            memory: 16Gi
          requests:
            cpu: '500m'
            memory: 2Gi
      exposure:
        loadBalancer:
          enabled: false
          port: 443
        nodePort:
          enabled: false
        route:
          enabled: true
      notifierSecretsEncryption:
        enabled: false
      persistence:
        persistentVolumeClaim:
          claimName: stackrox-db
      telemetry:
        enabled: true
    egress:
      connectivityPolicy: Online
    monitoring:
      openshift:
        enabled: true
    network:
      policies: Enabled
    scanner:
      analyzer:
        scaling:
          autoScaling: Enabled
          maxReplicas: 5
          minReplicas: 2
          replicas: 3
        resources:
          limits:
            cpu: '2'
            memory: 4Gi
          requests:
            cpu: '200m'
            memory: 512Mi
    scannerV4:
      db:
        persistence:
          persistentVolumeClaim:
            claimName: scanner-v4-db
        resources:
          limits:
            cpu: '2'
            memory: 4Gi
          requests:
            cpu: '200m'
            memory: 512Mi
      indexer:
        scaling:
          autoScaling: Enabled
          maxReplicas: 5
          minReplicas: 2
          replicas: 3
      matcher:
        scaling:
          autoScaling: Enabled
          maxReplicas: 5
          minReplicas: 2
          replicas: 3
      scannerComponent: Default

# Additional hub-only Prometheus alerts
prometheusRule:
  enabled: false
  name: rhacs-prometheus-rules
  namespace: ""
  labels:
    app: rhacs
  spec:
    groups:
      - name: rhacs-central
        rules:
          - alert: RHACSCentralScrapeFailed
            expr: |
              avg_over_time(up{pod=~"central-.*"}[10m]) < 0.5 and ON(pod) kube_pod_container_status_ready{container="central"} == 1
            for: 20m
            labels:
              severity: critical
            annotations:
              summary: "Prometheus unable to scrape metrics from target `{{ $labels.pod }}` in namespace `{{ $labels.namespace }}`."
              description: "During the last 10 minutes, only `{{ $value | humanizePercentage }}` of scrapes of target `{{ $labels.pod }}` in namespace `{{ $labels.namespace }}` were successful. This alert is raised when less than 50% of scrapes are successful."
              sop_url: "https://gitlab.cee.redhat.com/stackrox/acs-managed-service-runbooks/blob/master/sops/dp-003-rhacs-instance-unavailable.md"
          - alert: RHACSCentralContainerDown
            expr: |
              avg_over_time(kube_pod_container_status_ready{container="central"}[10m]) < 0.5
            for: 20m
            labels:
              severity: critical
            annotations:
              summary: "Central container `{{ $labels.pod }}/{{ $labels.container }}` in namespace `{{ $labels.namespace }}` is down or in a CrashLoopBackOff status."
              description: "Central container `{{ $labels.pod }}/{{ $labels.container }}` in namespace `{{ $labels.namespace }}` has been down or in a CrashLoopBackOff status for at least 10 minutes."
              sop_url: "https://gitlab.cee.redhat.com/stackrox/acs-managed-service-runbooks/blob/master/sops/dp-003-rhacs-instance-unavailable.md"
          - alert: RHACSCentralContainerFrequentlyRestarting
            expr: |
              increase(kube_pod_container_status_restarts_total{container="central"}[30m]) > 3
            labels:
              severity: critical
            annotations:
              summary: "Central container `{{ $labels.pod }}/{{ $labels.container }}` in namespace `{{ $labels.namespace }}` restarted more than 3 times."
              description: "Central container `{{ $labels.pod }}/{{ $labels.container }}` in namespace `{{ $labels.namespace }}` has restarted more than 3 times during the last 30 minutes."
              sop_url: "https://gitlab.cee.redhat.com/stackrox/acs-managed-service-runbooks/blob/master/sops/dp-003-rhacs-instance-unavailable.md"
          - alert: RHACSCentralPostgresConnectionDown
            expr: avg_over_time(rox_central_postgres_connected{container="central"}[10m]) < 0.5
            for: 20m
            labels:
              severity: critical
            annotations:
              summary: "Central container `{{ $labels.pod }}/{{ $labels.container }}` database connection in namespace `{{ $labels.namespace }}` is down or is in a bad shape."
              description: "Central container `{{ $labels.pod }}/{{ $labels.container }}` database connection in namespace `{{ $labels.namespace }}` has been down or is in a bad shape for at least 10 minutes."
              sop_url: "https://gitlab.cee.redhat.com/stackrox/acs-managed-service-runbooks/blob/master/sops/dp-010-rhacs-instance-db-unavailable.md"

      - name: rhacs-scanner
        rules:
          - alert: RHACSScannerScrapeFailed
            expr: |
              avg_over_time(up{pod=~"scanner-.*"}[10m]) < 0.5 and ON(pod) kube_pod_container_status_ready{pod=~"scanner.*", container=~"scanner|db"} == 1
            for: 20m
            labels:
              severity: critical
            annotations:
              summary: "Prometheus unable to scrape metrics from target `{{ $labels.pod }}` in namespace `{{ $labels.namespace }}`."
              description: "During the last 10 minutes, only `{{ $value | humanizePercentage }}` of scrapes of target `{{ $labels.pod }}` in namespace `{{ $labels.namespace }}` were successful. This alert is raised when less than 50% of scrapes are successful."
              sop_url: "https://gitlab.cee.redhat.com/stackrox/acs-managed-service-runbooks/blob/master/sops/dp-003-rhacs-instance-unavailable.md"
          - alert: RHACSScannerContainerDown
            expr: |
              avg_over_time(kube_pod_container_status_ready{pod=~"scanner.*", container=~"scanner|db"}[10m]) < 0.5
            for: 20m
            labels:
              severity: critical
            annotations:
              summary: "Scanner container `{{ $labels.pod }}/{{ $labels.container }}` in namespace `{{ $labels.namespace }}` is down or in a CrashLoopBackOff status."
              description: "Scanner container `{{ $labels.pod }}/{{ $labels.container }}` in namespace `{{ $labels.namespace }}` has been down or in a CrashLoopBackOff status for at least 10 minutes."
              sop_url: "https://gitlab.cee.redhat.com/stackrox/acs-managed-service-runbooks/blob/master/sops/dp-003-rhacs-instance-unavailable.md"
          - alert: RHACSScannerContainerFrequentlyRestarting
            expr: |
              increase(kube_pod_container_status_restarts_total{pod=~"scanner.*", container=~"scanner|db"}[30m]) > 3
            labels:
              severity: warning
            annotations:
              summary: "Scanner container `{{ $labels.pod }}/{{ $labels.container }}` in namespace `{{ $labels.namespace }}` restarted more than 3 times."
              description: "Scanner container `{{ $labels.pod }}/{{ $labels.container }}` in namespace `{{ $labels.namespace }}` has restarted more than 3 times during the last 30 minutes."
              sop_url: "https://gitlab.cee.redhat.com/stackrox/acs-managed-service-runbooks/blob/master/sops/dp-003-rhacs-instance-unavailable.md"

