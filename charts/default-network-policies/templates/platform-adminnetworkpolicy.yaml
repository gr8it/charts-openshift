{{- if .Values.createPlatformPolicies }}
apiVersion: policy.networking.k8s.io/v1alpha1
kind: AdminNetworkPolicy
metadata:
  name: platform-anp-policy
  labels:
    {{- include "default-network-policies.labels" . | nindent 4 }}
spec:
  priority: 30
  subject:
    namespaces:
      matchExpressions:
        - key: apc.namespace.type
          operator: In
          values:
            - platform
  ingress:
    - name: allow-ingress-from-monitoring
      action: Allow
      from:
        - namespaces:
            matchExpressions:
              - key: kubernetes.io/metadata.name
                operator: In
                values:
                  - openshift-monitoring
                  - openshift-user-workload-monitoring
    - name: allow-ingress-from-konnectivity
      action: Allow
      from:
        - pods:
            namespaceSelector:
              matchExpressions:
                - key: kubernetes.io/metadata.name
                  operator: In
                  values:
                    - kube-system
            podSelector:
              matchExpressions:
                - key: app
                  operator: In
                  values:
                    - konnectivity-agent
    - name: allow-ingress-from-openshift-storage
      action: Allow
      from:
        - pods:
            namespaceSelector:
              matchExpressions:
                - key: kubernetes.io/metadata.name
                  operator: In
                  values:
                    - openshift-storage
            podSelector:
              matchExpressions:
                - key: app.kubernetes.io/name
                  operator: In
                  values:
                    - csi-addons
    - name: allow-ingress-from-openshift-operators
      action: Allow
      from:
        - namespaces:
            matchExpressions:
              - key: kubernetes.io/metadata.name
                operator: In
                values:
                  - openshift-operators
    - name: allow-ingress-from-crossplane-namespace
      action: Allow
      from:
        - namespaces:
            matchExpressions:
              - key: kubernetes.io/metadata.name
                operator: In
                values:
                  - {{ .Values.crossplaneNamespace }}
    - name: pass-ingress-from-application-namespaces
      action: Pass
      from:
        - namespaces:
            matchExpressions:
              - key: apc.namespace.type
                operator: In
                values:
                  - application
    - name: pass-ingress-from-platform-namespaces
      action: Pass
      from:
        - namespaces:
            matchExpressions:
              - key: apc.namespace.type
                operator: In
                values:
                  - platform
  egress:
    - name: allow-egress-inside-cluster
      action: Allow
      to:
      - namespaces: {}
      - nodes: {}
    {{- if (include "apc-global-overrides.proxyIPs" . | fromYamlArray) }}
    - name: pass-egress-to-proxy
      action: Pass
      to:
      - networks:
        {{- (include "apc-global-overrides.proxyIPs" .) | nindent 8 }}
    {{- end }}
    - name: allow-all-private-cidrs-for-cluster-external-traffic
      action: Allow
      to:
      - networks:
        - 10.0.0.0/8
        - 172.16.0.0/12
        - 192.168.0.0/16
---
{{- end }}
