{{- if eq "true" (include "apc-global-overrides.boolDefaults" (list .Values.createApplicationPolicies (include "apc-global-overrides.clusterRunsApps" .) true)) }}
apiVersion: policy.networking.k8s.io/v1alpha1
kind: AdminNetworkPolicy
metadata:
  name: application-anp-policy
  labels:
    {{- include "default-network-policies.labels" . | nindent 4 }}
spec:
  priority: 40
  subject:
    namespaces:
      matchExpressions:
        - key: apc.namespace.type
          operator: In
          values:
            - application
  ingress:
    - name: allow-ingress-from-monitoring
      action: Allow
      from:
        - namespaces:
            matchExpressions:
              - key: kubernetes.io/metadata.name
                operator: In
                values:
                  - openshift-monitoring
                  - openshift-user-workload-monitoring
    - name: allow-ingress-from-openshift-operators
      action: Allow
      from:
        - namespaces:
            matchExpressions:
              - key: kubernetes.io/metadata.name
                operator: In
                values:
                  - openshift-operators
    - name: allow-ingress-from-crossplane-namespace
      action: Allow
      from:
        - namespaces:
            matchExpressions:
              - key: kubernetes.io/metadata.name
                operator: In
                values:
                  - {{ .Values.crossplaneNamespace }}
    - name: pass-ingress-from-application-namespaces
      action: Pass
      from:
        - namespaces:
            matchExpressions:
              - key: apc.namespace.type
                operator: In
                values:
                  - application
    - name: pass-ingress-from-platform-namespaces
      action: Pass
      from:
        - namespaces:
            matchExpressions:
              - key: apc.namespace.type
                operator: In
                values:
                  - platform
  egress:
    - name: allow-egress-inside-cluster
      action: Allow
      to:
      - namespaces: {}
      - nodes: {}
    {{- if (include "apc-global-overrides.proxyCIDRs" . | fromYamlArray) }}
    - name: pass-egress-to-proxy
      action: Pass
      to:
      - networks:
        {{- (include "apc-global-overrides.proxyCIDRs" . ) | nindent 8 }}
    {{- end }}
    - name: allow-all-private-cidrs-for-cluster-external-traffic
      action: Allow
      to:
      - networks:
        - 10.0.0.0/8
        - 172.16.0.0/12
        - 192.168.0.0/16
---
{{- end }}
