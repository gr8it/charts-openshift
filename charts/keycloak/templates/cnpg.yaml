apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: {{ include "keycloak.fullname" . }}-db
  namespace: {{ .Release.Namespace }}
  labels:
    app: keycloak
  {{- include "keycloak.labels" . | nindent 4 }}
spec:
  affinity:
    podAntiAffinityType: preferred
  backup:
    barmanObjectStore:
      destinationPath: s3://{{ .Values.bucketName | default (print (include "keycloak.fullname" .) "-backup") }}
      endpointURL: http://s3.openshift-storage.svc
      s3Credentials:
        accessKeyId:
          key: access_key_id
          name: {{ include "keycloak.fullname" . }}-backup-allinfo
        secretAccessKey:
          key: access_key_secret
          name: {{ include "keycloak.fullname" . }}-backup-allinfo
      wal:
        compression: bzip2
        maxParallel: 4
    retentionPolicy: {{ .Values.cnpg.cluster.backup.retentionPolicy | default "2w" }}
    target: prefer-standby
  bootstrap:
    initdb:
      dataChecksums: true
      database: keycloak
      encoding: UTF8
      localeCType: en_US.utf8
      localeCollate: en_US.utf8
      owner: keycloak
      secret:
        name: {{ include "keycloak.fullname" . }}-db-auth
      walSegmentSize: 1
  imageName: {{ .Values.cnpg.cluster.image.name }}:{{ .Values.cnpg.cluster.image.tag  }}
  instances: {{ .Values.cnpg.cluster.instances | default 3 }}
  maxSyncReplicas: {{ .Values.cnpg.cluster.maxSyncReplicas | default 2 }}
  minSyncReplicas: {{ .Values.cnpg.cluster.minSyncReplicas }}
  monitoring:
    enablePodMonitor: true
  postgresql:
    parameters:
      max_slot_wal_keep_size: 500MB
      shared_buffers: 256MB
      wal_keep_size: "200"
    syncReplicaElectionConstraint:
      enabled: false
      nodeLabelsAntiAffinity:
      - topology.kubernetes.io/zone
  primaryUpdateMethod: switchover
  primaryUpdateStrategy: unsupervised
  replicationSlots:
    updateInterval: 30
  resources:
    {{ if .Values.cnpg.cluster.resources }}
    {{ toYaml .Values.cnpg.cluster.resources | indent 4 }}
    {{ else }}
    limits:
      cpu: "1"
      memory: 500Mi
    requests:
      cpu: 100m
      memory: 500Mi
    {{ end }}  
  storage:
    size: {{ .Values.cnpg.cluster.storage.size | default "1Gi" }}
  walStorage:
    size: {{ .Values.cnpg.cluster.walStorage.size | default "1Gi" }}
