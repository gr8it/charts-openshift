{{- if not .Values.disabled }}
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: uwm-application-cluster-policy
  labels:
    {{- include "user-workload-monitoring-policy.labels" . | nindent 4 }}
spec:
  generateExistingOnPolicyUpdate: true
  rules:
  - name: generate-prometheus-rules-application
    match:
      any:
      - resources:
          kinds:
          - Namespace
    preconditions:
      all:
      - key: {{ "{{request.object.metadata.labels.\"openshift.io/cluster-monitoring\" || ''}}" | quote }}
        operator: In
        value:
        - ""
        - "true"
      - key: {{ "{{request.object.metadata.labels.\"openshift.io/user-monitoring\" || ''}}" | quote }}
        operator: In
        value:
        - ""
        - "true"
      - key: {{ "{{request.object.metadata.labels.\"apc.namespace.type\" || ''}}" | quote }}
        operator: Equals
        value: "application"
    exclude:
      any:
      - resources:
          kinds:
          - Namespace
          names:
          - "openshift*"
          - "kube*"
          - "default"
    generate:
      synchronize: true
      apiVersion: monitoring.coreos.com/v1
      kind: PrometheusRule
      name: "user-workload-monitoring-{{`{{request.object.metadata.name}}`}}"
      namespace: "{{`{{request.object.metadata.name}}`}}"
      data:
        metadata:
          labels:
            monitoring.workload/auto-generated: "true"
            prometheus: kube-prometheus
            role: alert-rules
        spec:
          groups:
          - name: "user-workload-{{`{{request.object.metadata.name}}`}}"
            rules:
            {{- range .Values.prometheusRule.rules }}
            - alert: {{ .alert }}
              expr: {{ .expr | quote }}
              for: {{ .for }}
              labels:
                severity: low #informative
                namespace: "{{`{{request.object.metadata.name}}`}}"
              annotations:
                description: {{ .description | quote }}
                summary: {{ .summary | quote }}
            {{- end }}
{{- end }}
