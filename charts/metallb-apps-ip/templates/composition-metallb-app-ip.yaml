apiVersion: apiextensions.crossplane.io/v1
kind: Composition
metadata:
  name: metallb-app-ip
  labels:
    crossplane.io/xrd: metallbappips.metallb.crossplane.io
spec:
  compositeTypeRef:
    apiVersion: metallb.crossplane.io/v1alpha1
    kind: MetalLBAppIP
  mode: Pipeline
  pipeline:
    # Step 0: Get existing IPAddressPool IPs from local K8S cluster
    - step: get-existing-ips
      functionRef:
        name: function-cue
      input:
        apiVersion: cue.fn.crossplane.io/v1beta1
        kind: CueInput
        metadata:
          name: get-existing-ips
        spec:
          code: |
            import (
              "encoding/json"
              "list"
            )

            // Read all IPAddressPool resources from the cluster
            pools: {
              apiVersion: "metallb.io/v1beta1"
              kind: "IPAddressPool"
            }

            // Extract addresses from all pools
            _poolList: list.Flatten([
              for pool in __kubeClient.Resources.items {
                if pool.kind == "IPAddressPool" {
                  pool.spec.addresses
                }
              }
            ])

            // Output the list of existing IPs to composite status
            _existingIPs: list.FlattenN(_poolList, 1)

            // Return results for use in pipeline
            results: {
              existingIPAddressPools: _existingIPs
            }
    # Step 1: Read ConfigMap apc-metallbips-range for metallb address ranges using Kubernetes provider
    - step: read-config
      functionRef:
        name: function-kubernetes-read
      input:
        apiVersion: k8sfn.crossplane.io/v1beta1
        kind: ReadResource
        metadata:
          name: read-metallb-config
        spec:
          forProvider:
            apiVersion: v1
            kind: ConfigMap
            name: apc-metallbips-range
            namespace: metallb
          providerConfigRef:
            name: k8s-provider
      output:
        toFieldPath: spec.configMapData
    # Step 2: Selected 1st available IP from the configured ranges excluding already assigned IPs
    - step: select-ips
      functionRef:
        name: function-cue
      input:
        apiVersion: cue.fn.crossplane.io/v1beta1
        kind: CueInput
        metadata:
          name: select-ips
        spec:
          code: |
            import (
              "encoding/json"
              "list"
              "net"
              "strings"
            )

            // Get configured address ranges from ConfigMap
            _configData: __kubeClient.Resources.configMapData
            _ranges: json.Unmarshal(_configData["ranges"])

            // Get existing IPs from previous step
            _existingIPs: __kubeClient.Resources.existingIPAddressPools

            // Parse CIDR ranges and generate available IPs
            _generateAvailableIPs: {
              for cidr in _ranges {
                let network = net.ParseCIDR(cidr)
                let ips = net.HostsInNetwork(network)
                for ip in ips {
                  ip
                }
              }
            }

            // Filter out already assigned IPs
            _availableIPs: [
              for ip in _generateAvailableIPs {
                if !list.Contains(_existingIPs, ip) {
                  ip
                }
              }
            ]

            // Select first available IP
            _selectedIP: _availableIPs[0]

            // Return results
            results: {
              allocatedAddresses: [_selectedIP]
            }
    # Step 3: Patch and transform resources with allocated IPs
    - step: patch-and-transform
      functionRef:
        name: function-patch-and-transform
      input:
        apiVersion: pt.crossplane.io/v1beta1
        kind: Resources
        metadata:
          name: metallb-resources
        spec:
          resources:
            # IPAddressPool Resource
            - name: ip-address-pool
              base:
                apiVersion: metallb.io/v1beta1
                kind: IPAddressPool
                metadata:
                  namespace: default
                  name: metallb-pool
                spec:
                  addresses:
                    - 10.0.0.0/24
                  autoAssign: true
              patches:
                # Use claim's namespace for the pool namespace
                - type: FromCompositeFieldValue
                  fromFieldPath: metadata.namespace
                  toFieldPath: metadata.namespace
                # Use claim's name for the pool name
                - type: FromCompositeFieldValue
                  fromFieldPath: metadata.name
                  toFieldPath: metadata.name
                # Get allocated address from status (set by read-config step)
                - type: FromCompositeFieldValue
                  fromFieldPath: status.allocatedAddresses
                  toFieldPath: spec.addresses
                # Copy autoAssign setting from claim
                - type: FromCompositeFieldValue
                  fromFieldPath: spec.autoAssign
                  toFieldPath: spec.autoAssign
                # Write back IPAddressPool status to composite status
                - type: ToCompositeFieldValue
                  fromFieldPath: metadata.name
                  toFieldPath: status.addressPool.name
                - type: ToCompositeFieldValue
                  fromFieldPath: status.conditions
                  toFieldPath: status.addressPool.conditions
                - type: ToCompositeFieldValue
                  fromFieldPath: spec.addresses
                  toFieldPath: status.addressPool.addresses

            # L2Advertisement Resource
            - name: l2-advertisement
              base:
                apiVersion: metallb.io/v1beta1
                kind: L2Advertisement
                metadata:
                  namespace: default
                  name: metallb-l2-adv
                spec:
                  ipAddressPools: []
                  interfaces: []
              patches:
                # Use claim's namespace for the advertisement namespace
                - type: FromCompositeFieldValue
                  fromFieldPath: metadata.namespace
                  toFieldPath: metadata.namespace
                # Generate unique L2Advertisement name from namespace and claim name
                - type: CombineFromComposite
                  combine:
                    variables:
                      - fromFieldPath: metadata.namespace
                      - fromFieldPath: metadata.name
                    strategy: string
                    string:
                      fmt: "%s-%s-l2-adv"
                  toFieldPath: metadata.name
                # Reference the IPAddressPool by claim name
                - type: FromCompositeFieldValue
                  fromFieldPath: metadata.name
                  toFieldPath: spec.ipAddressPools[0]
                # Copy interfaces if provided
                - type: FromCompositeFieldValue
                  fromFieldPath: spec.interfaces
                  toFieldPath: spec.interfaces
                # Write back L2Advertisement status to composite status
                - type: ToCompositeFieldValue
                  fromFieldPath: metadata.name
                  toFieldPath: status.l2Advertisement.name
                - type: ToCompositeFieldValue
                  fromFieldPath: status.conditions
                  toFieldPath: status.l2Advertisement.conditions

    # Step 3: Readiness checks for the composite resource
    - step: ready
      functionRef:
        name: function-ready
      input:
        apiVersion: ready.crossplane.io/v1beta1
        kind: ReadinessChecks
        metadata:
          name: metallb-ready
        spec:
          checks:
            - type: MatchCondition
              fieldValue: "True"
              matchCondition:
                type: Ready
                status: "True"
              resource:
                apiVersion: metallb.io/v1beta1
                kind: IPAddressPool
            - type: MatchCondition
              fieldValue: "True"
              matchCondition:
                type: Ready
                status: "True"
              resource:
                apiVersion: metallb.io/v1beta1
                kind: L2Advertisement
