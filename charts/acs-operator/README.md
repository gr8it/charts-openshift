# ACS Operator Helm Chart

This Helm chart installs the Red Hat Advanced Cluster Security (RHACS) operator and configures a secured cluster.

## Architecture

This chart uses a **dependency-based architecture** for operator installation:

### How It Works

1. **Dependency Chart** (`acm-operatorpolicy`) creates:
   - `OperatorPolicy` resource → which ACM uses to automatically create:
     - Operator namespace (`rhacs-operator`)
     - OperatorGroup
     - Subscription

2. **Our Chart Templates** create:
   - `Namespace` for stackrox
   - `SecuredCluster` custom resource

### Resource Flow

```
acs-operator (our chart)
├── Chart.yaml
│   └── dependencies: acm-operatorpolicy  ← Downloads dependency chart
├── values.yaml
│   └── acm-operatorpolicy:               ← Values passed to dependency
│       subscription:
│         name: rhacs-operator
└── templates/
    ├── namespace.yaml                    ← Creates stackrox namespace
    └── securedcluster.yaml               ← Creates SecuredCluster CR

Dependency Chart (acm-operatorpolicy)
└── templates/
    └── operatorpolicy.yaml               ← Creates OperatorPolicy
        └── ACM reads this and creates:
            ├── Namespace (rhacs-operator)
            ├── OperatorGroup
            └── Subscription
```

## Components

This chart installs the following components:

1. **RHACS Operator** - Installed via ACM OperatorPolicy (dependency chart)
   - Operator namespace, OperatorGroup, and Subscription are automatically created by ACM
2. **Stackrox Namespace** - The namespace where ACS components run (our template)
3. **SecuredCluster** - The ACS secured cluster configuration (our template)

## Prerequisites

- OpenShift 4.x cluster
- Access to Red Hat Operators catalog
- ACM (Advanced Cluster Management) installed for operator policy management

## Configuration

### Operator Configuration

The operator is configured through the `acm-operatorpolicy` dependency:

```yaml
acm-operatorpolicy:
  subscription:
    channel: stable
    name: rhacs-operator
    namespace: rhacs-operator
    startingCSV: rhacs-operator.v4.6.1
  upgradeApproval: Manual
```

### Secured Cluster Configuration

Key configuration parameters:

- `securedCluster.clusterName`: Name of the cluster (override per environment)
- `securedCluster.centralEndpoint`: URL to the ACS Central instance
- `securedCluster.admissionControl`: Admission controller settings
- `securedCluster.scanner`: Scanner configuration
- `securedCluster.scannerV4`: Scanner V4 configuration

## Installation

```bash
helm install acs-operator ./acs-operator \
  --set securedCluster.clusterName=dev01 \
  --set securedCluster.centralEndpoint=https://central-stackrox.apps.hub01.cloud.socpoist.sk:443
```

## Values Override Per Environment

For different environments, override the cluster-specific values:

```yaml
securedCluster:
  clusterName: prod01  # Change per environment
  centralEndpoint: 'https://central-stackrox.apps.hub01.cloud.socpoist.sk:443'
```

## Comparison: OperatorPolicy vs Direct Manifests

### What OperatorPolicy Creates

The `OperatorPolicy` approach is **functionally equivalent** to direct manifests but adds monitoring and compliance:

| Component | Direct Manifest | OperatorPolicy | Notes |
|-----------|----------------|----------------|-------|
| **Namespace** | ✅ Created explicitly | ✅ Auto-created from `subscription.namespace` | Same result |
| **OperatorGroup** | ✅ With `generateName` | ✅ Auto-generated by ACM | Functionally equivalent |
| **Subscription** | ✅ With `installPlanApproval: Manual` | ✅ From `upgradeApproval: Manual` | Same behavior |
| **Monitoring** | ❌ None | ✅ ACM monitors operator health | **Bonus!** |
| **Compliance** | ❌ None | ✅ Tracks deployment status | **Bonus!** |

### Original Manifest Translation

```yaml
# Original: 01-operator.yaml
---
apiVersion: v1
kind: Namespace
metadata:
  name: rhacs-operator
---
apiVersion: operators.coreos.com/v1
kind: OperatorGroup
metadata:
  generateName: rhacs-operator-
  namespace: rhacs-operator
spec:
  upgradeStrategy: Default
---
apiVersion: operators.coreos.com/v1alpha1
kind: Subscription
metadata:
  name: rhacs-operator
  namespace: rhacs-operator
spec:
  channel: stable
  installPlanApproval: Manual
  name: rhacs-operator
  source: redhat-operators
  sourceNamespace: openshift-marketplace
  startingCSV: rhacs-operator.v4.6.1
```

**Becomes:**

```yaml
# OperatorPolicy (created by dependency chart)
apiVersion: policy.open-cluster-management.io/v1beta1
kind: OperatorPolicy
spec:
  upgradeApproval: Manual              # → Sets installPlanApproval: Manual
  subscription:
    channel: stable
    name: rhacs-operator
    namespace: rhacs-operator          # → Creates namespace + OperatorGroup
    source: redhat-operators
    sourceNamespace: openshift-marketplace
    startingCSV: rhacs-operator.v4.6.1
  versions:
    - rhacs-operator.v4.6.1
```

ACM reads this OperatorPolicy and automatically creates the namespace, OperatorGroup, and Subscription with the correct settings.

## Dependencies

This chart depends on:

- `acm-operatorpolicy` (v1.3.0) - For operator installation via ACM
