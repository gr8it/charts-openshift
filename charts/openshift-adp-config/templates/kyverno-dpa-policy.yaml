{{- if and .Values.kyverno.enabled (.Values.kyverno.dpaPolicy.enabled | default false) }}
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: {{ include "openshift-adp-config.fullname" . }}-generate-dpa
  labels:
    {{- include "openshift-adp-config.labels" . | nindent 4 }}
spec:
  background: true
  rules:
    - name: generate-dpa
      match:
        any:
          - resources:
              kinds: ["ConfigMap"]
              namespaces: ["{{ .Values.kyverno.dpaPolicy.configMapNamespace }}"]
              names: ["openshift-service-ca.crt"]
      context:
        - name: serviceCA
          configMap:
            name: openshift-service-ca.crt
            namespace: {{ .Values.kyverno.dpaPolicy.configMapNamespace }}
      generate:
        apiVersion: oadp.openshift.io/v1alpha1
        kind: DataProtectionApplication
        name: {{ .Values.dpa.name }}
        namespace: {{ .Values.targetNamespace }}
        # Keep the generated DPA in sync with the referenced ConfigMap contents.
        synchronize: {{ default true .Values.kyverno.synchronize }}
        # Generate the DPA immediately if the ConfigMap already exists.
        generateExisting: {{ default true .Values.kyverno.generateExisting }}
        # Leave the generated DPA in place if this policy is removed.
        orphanDownstreamOnPolicyDelete: {{ default true .Values.kyverno.orphanDownstreamOnPolicyDelete }}
        data:
          apiVersion: oadp.openshift.io/v1alpha1
          kind: DataProtectionApplication
          metadata:
            name: {{ .Values.dpa.name }}
            namespace: {{ .Values.targetNamespace }}
            labels:
{{ include "openshift-adp-config.labels" . | nindent 12 }}
          spec:
{{ include "openshift-adp-config.dpaSpec" (dict "root" . "caCert" (printf "\"{{ serviceCA.data.\\\"service-ca.crt\\\" | b64enc }}\"")) | nindent 12 }}
{{- end }}
