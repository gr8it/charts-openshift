apiVersion: oadp.openshift.io/v1alpha1
kind: DataProtectionApplication
metadata:
  name: {{ .Values.dpa.name }}
  namespace: {{ .Values.targetNamespace }}
  labels:
    {{- include "apc-global-overrides.labels" . | nindent 4 }}
spec:
  backupLocations:
  {{- range .Values.dpa.backupLocations }}
  - name: {{ tpl .name $ }}
    velero:
      accessMode: ReadWrite
      config:
        insecureSkipTLSVerify: {{ $.Values.dpa.s3.insecureSkipTLSVerify | quote }}
        profile: default
        region: {{ $.Values.dpa.s3.region }}
        s3ForcePathStyle: {{ $.Values.dpa.s3.forcePathStyle | quote }}
        s3Url: {{ $.Values.dpa.s3.url }}
      credential:
        key: cloud
        {{- if .default }}
        name: {{ tpl $.Values.credentials.backup.targetName $ }}
        {{- else }}
        name: {{ tpl $.Values.credentials.restore.targetName $ }}
        {{- end }}
      default: {{ .default }}
      objectStorage:
        bucket: {{ tpl .bucket $ }}
        caCert: {{ $.Values.dpa.s3.caCert }}
        prefix: {{ tpl .prefix $ }}
      provider: aws
  {{- end }}
  configuration:
    nodeAgent:
      enable: {{ .Values.dpa.nodeAgent.enabled }}
      podConfig:
        resourceAllocations:
          limits:
            cpu: {{ .Values.dpa.nodeAgent.resourceAllocations.limits.cpu | quote }}
            memory: {{ .Values.dpa.nodeAgent.resourceAllocations.limits.memory }}
          requests:
            cpu: {{ .Values.dpa.nodeAgent.resourceAllocations.requests.cpu | quote }}
            memory: {{ .Values.dpa.nodeAgent.resourceAllocations.requests.memory }}
      uploaderType: {{ .Values.dpa.nodeAgent.uploaderType }}
    velero:
      defaultPlugins:
      {{- range .Values.dpa.velero.defaultPlugins }}
      - {{ . }}
      {{- end }}
      defaultSnapshotMoveData: {{ .Values.dpa.velero.defaultSnapshotMoveData }}
      defaultVolumesToFSBackup: {{ .Values.dpa.velero.defaultVolumesToFSBackup }}
      resourceTimeout: {{ .Values.dpa.velero.resourceTimeout }}