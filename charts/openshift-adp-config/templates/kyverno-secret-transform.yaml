{{- if .Values.kyverno.enabled }}
{{- $awsAccessKeyIdExpr := printf "{{ base64_decode('{{ request.object.data.AWS_ACCESS_KEY_ID }}') }}" -}}
{{- $awsSecretAccessKeyExpr := printf "{{ base64_decode('{{ request.object.data.AWS_SECRET_ACCESS_KEY }}') }}" -}}
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: {{ include "apc-global-overrides.fullname" . }}-oadp-cloud-credentials
  labels:
    {{- include "apc-global-overrides.labels" . | nindent 4 }}
spec:
  background: true
  rules:
    - name: transform-backup-secret
      match:
        any:
          - resources:
              kinds:
                - Secret
              namespaces:
                - {{ .Values.sourceNamespace }}
              names:
                - {{ tpl .Values.credentials.backup.sourceName . }}
      generate:
        generateExisting: true
        synchronize: true
        orphanDownstreamOnPolicyDelete: true
        apiVersion: v1
        kind: Secret
        name: {{ tpl .Values.credentials.backup.targetName . }}
        namespace: {{ .Values.targetNamespace }}
        data:
          metadata:
            labels:
              {{- include "apc-global-overrides.labels" . | nindent 14 }}
              dataprotectionapplication.name: {{ .Values.dpa.name }}
              openshift.io/oadp: "true"
          type: Opaque
          stringData:
            cloud: |
              [default]
              aws_access_key_id: "{{ $awsAccessKeyIdExpr }}"
              aws_secret_access_key: "{{ $awsSecretAccessKeyExpr }}"
    - name: transform-restore-secret
      match:
        any:
          - resources:
              kinds:
                - Secret
              namespaces:
                - {{ .Values.sourceNamespace }}
              names:
                - {{ tpl .Values.credentials.restore.sourceName . }}
      generate:
        generateExisting: true
        synchronize: true
        orphanDownstreamOnPolicyDelete: true
        apiVersion: v1
        kind: Secret
        name: {{ tpl .Values.credentials.restore.targetName . }}
        namespace: {{ .Values.targetNamespace }}
        data:
          metadata:
            labels:
              {{- include "apc-global-overrides.labels" . | nindent 14 }}
              dataprotectionapplication.name: {{ .Values.dpa.name }}
              openshift.io/oadp: "true"
          type: Opaque
          stringData:
            cloud: |
              [default]
              aws_access_key_id: "{{ $awsAccessKeyIdExpr }}"
              aws_secret_access_key: "{{ $awsSecretAccessKeyExpr }}"
{{- end }}
