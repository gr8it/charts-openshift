{{- if .Values.kyverno.enabled }}
{{- /* compute names with safe defaults */ -}}
{{- $cluster := include "apc-global-overrides.clusterName" . -}}

{{- $sourceNs := default "apc-backup" .Values.sourceNamespace -}}
{{- $targetNs := default "openshift-adp" .Values.targetNamespace -}}

{{- $backupSourceDefault := printf "oadp-%s-app-backup" $cluster -}}
{{- $backupTargetDefault := printf "oadp-%s-app-backup-cloud-credentials" $cluster -}}
{{- $restoreSourceDefault := printf "oadp-%s-app-restore" $cluster -}}
{{- $restoreTargetDefault := printf "oadp-%s-app-restore-cloud-credentials" $cluster -}}

{{- $backupSourceName := default $backupSourceDefault (default "" .Values.credentials.backup.sourceName) -}}
{{- $backupTargetName := default $backupTargetDefault (default "" .Values.credentials.backup.targetName) -}}
{{- $restoreSourceName := default $restoreSourceDefault (default "" .Values.credentials.restore.sourceName) -}}
{{- $restoreTargetName := default $restoreTargetDefault (default "" .Values.credentials.restore.targetName) -}}

apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: {{ include "apc-global-overrides.fullname" . }}-oadp-cloud-credentials
  labels:
    {{- include "apc-global-overrides.labels" . | nindent 4 }}
    {{- with .Chart }}
    helm.sh/chart: {{ .Name }}-{{ .Version | replace "+" "_" }}
    {{- end }}
    app.kubernetes.io/managed-by: {{ .Release.Service }}
spec:
  background: true
  rules:
    - name: transform-backup-secret
      skipBackgroundRequests: {{ default false .Values.kyverno.skipBackgroundRequests }}
      match:
        any:
          - resources:
              kinds: ["Secret"]
              namespaces: ["{{ $sourceNs }}"]
              names: ["{{ $backupSourceName }}"]
      generate:
        apiVersion: v1
        kind: Secret
        name: "{{ $backupTargetName }}"
        namespace: "{{ $targetNs }}"
        generateExisting: {{ default true .Values.kyverno.generateExisting }}
        synchronize: {{ default true .Values.kyverno.synchronize }}
        orphanDownstreamOnPolicyDelete: {{ default true .Values.kyverno.orphanDownstreamOnPolicyDelete }}
        data:
          metadata:
            labels:
              {{- include "apc-global-overrides.labels" . | nindent 14 }}
              {{- if .Values.dpa.name }}
              dataprotectionapplication.name: "{{ .Values.dpa.name }}"
              {{- end }}
              openshift.io/oadp: "true"
          type: Opaque
          stringData:
            cloud: |
              [default]
              aws_access_key_id: "{{ "{{" }} base64_decode(request.object.data.AWS_ACCESS_KEY_ID || '') {{ "}}" }}"
              aws_secret_access_key: "{{ "{{" }} base64_decode(request.object.data.AWS_SECRET_ACCESS_KEY || '') {{ "}}" }}"

    - name: transform-restore-secret
      skipBackgroundRequests: {{ default false .Values.kyverno.skipBackgroundRequests }}
      match:
        any:
          - resources:
              kinds: ["Secret"]
              namespaces: ["{{ $sourceNs }}"]
              names: ["{{ $restoreSourceName }}"]
      generate:
        apiVersion: v1
        kind: Secret
        name: "{{ $restoreTargetName }}"
        namespace: "{{ $targetNs }}"
        generateExisting: {{ default true .Values.kyverno.generateExisting }}
        synchronize: {{ default true .Values.kyverno.synchronize }}
        orphanDownstreamOnPolicyDelete: {{ default true .Values.kyverno.orphanDownstreamOnPolicyDelete }}
        data:
          metadata:
            labels:
              {{- include "apc-global-overrides.labels" . | nindent 14 }}
              {{- if .Values.dpa.name }}
              dataprotectionapplication.name: "{{ .Values.dpa.name }}"
              {{- end }}
              openshift.io/oadp: "true"
          type: Opaque
          stringData:
            cloud: |
              [default]
              aws_access_key_id: "{{ "{{" }} base64_decode(request.object.data.AWS_ACCESS_KEY_ID || '') {{ "}}" }}"
              aws_secret_access_key: "{{ "{{" }} base64_decode(request.object.data.AWS_SECRET_ACCESS_KEY || '') {{ "}}" }}"
{{- end }}
