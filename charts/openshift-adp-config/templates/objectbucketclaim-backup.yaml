{{- if .Values.objectBucketClaims.enabled }}
{{- $env := tpl (include "apc-global-overrides.environment" .) $ }}
{{- $defaults := list
  (dict "name" (printf "oadp-%s-app-backup" $env) "bucket" "" "prefix" (printf "backup/%s-app" $env) "default" true)
  (dict "name" (printf "oadp-%s-app-restore" $env) "bucket" "" "prefix" (printf "backup/%s-app" $env) "default" false)
}}
{{- $providedLocations := .Values.dpa.backupLocations | default (list) }}
{{- $backupDefaults := index $defaults 0 }}
{{- $backupOverride := dict }}
{{- if lt 0 (len $providedLocations) }}
  {{- $backupOverride = index $providedLocations 0 }}
{{- end }}
{{- $backupCombined := merge (dict) $backupDefaults $backupOverride }}
{{- $backupNameValue := index $backupCombined "name" }}
{{- if eq (printf "%v" $backupNameValue) "" }}
  {{- $backupNameValue = index $backupDefaults "name" }}
{{- end }}
{{- $backupObcName := tpl (printf "%v" $backupNameValue) $ }}
{{- $backupBucketValue := index $backupCombined "bucket" }}
{{- if eq (printf "%v" $backupBucketValue) "" }}
  {{- $backupBucketValue = index $backupDefaults "bucket" }}
{{- end }}
{{- $backupBucket := tpl (printf "%v" $backupBucketValue) $ }}
apiVersion: objectbucket.io/v1alpha1
kind: ObjectBucketClaim
metadata:
  name: {{ $backupObcName }}
  namespace: {{ .Values.sourceNamespace }}
  labels:
    {{- include "apc-global-overrides.labels" . | nindent 4 }}
    bucket-provisioner: openshift-storage.ceph.rook.io-bucket
spec:
  bucketName: {{ $backupBucket }}
  generateBucketName: {{ $backupObcName }}
  objectBucketName: obc-{{ .Values.sourceNamespace }}-{{ $backupObcName }}
  storageClassName: {{ .Values.objectBucketClaims.backup.storageClassName | default "ocs-storagecluster-ceph-rgw" }}
{{- end }}
