apiVersion: batch/v1
kind: Job
metadata:
  name: vault-init-job
  namespace: {{ .Release.Namespace }}
  labels:
  {{- include "vault-helm.labels" $ | nindent 4 }}
spec:
  backoffLimit: 0
  template:
    spec:
      serviceAccountName: {{ .Release.Name }}
      containers:
        - name: vault-init-container
          image: {{ .Values.init.image }}:{{ .Values.init.tag }}
          command: ["sh", "-c"]
          args:
            - |
              echo "=== Starting Vault initialization ==="
              /opt/vault-init/vault-init.sh
              rc=$?
              if [[ $rc -ne 0 ]]; then
                echo "ERROR: Vault initialization failed with exit code $rc"
                exit $rc
              fi
              {{- if .Values.logging.enabled}}
              /opt/vault-init/enable-logging.sh
              rc=$?
              if [[ $rc -ne 0 ]]; then
                echo "ERROR: Vault logging setup failed with exit code $rc"
                exit $rc
              fi
              {{- end }}
              echo "=== Vault initialization completed ==="
          securityContext: {}
          env:
          - name: VAULT_INSTANCE
            value: "{{ .Release.Name }}"
          volumeMounts:
            - name: init-scripts
              mountPath: /opt/vault-init
      volumes:
        - name: init-scripts
          configMap:
            name: {{ .Release.Name }}-init-scripts
            defaultMode: 0755
      restartPolicy: Never

{{- if .Values.backup.enabled }} 
---
apiVersion: batch/v1
kind: Job
metadata:
  name: vault-backup-init-job
  namespace: {{ .Release.Namespace }}
  labels:
  {{- include "vault-helm.labels" $ | nindent 4 }}
spec:
  backoffLimit: 0
  template:
    spec:
      serviceAccountName: {{ .Release.Name }}
      containers:
        - name: vault-backup-init-container
          image: {{ .Values.init.image }}:{{ .Values.init.tag }}
          command: ["sh", "-c"]
          args:
            - |
              echo "=== Starting Backup initialization ==="
              /opt/vault-init/backup-init.sh
              rc=$?
              if [[ $rc -ne 0 ]]; then
                echo "ERROR: Backup initialization failed with exit code $rc"
                exit $rc
              fi
              /opt/vault-init/bucket-credentials.sh
              rc=$?
              if [[ $rc -ne 0 ]]; then
                echo "ERROR: Bucket credentials setup failed with exit code $rc"
                exit $rc
              fi
              echo "=== Backup initialization completed ==="
          securityContext: {}
          env:
          - name: VAULT_INSTANCE
            value: "{{ .Release.Name }}"
          - name: BACKUP_BUCKET
            value: "{{ .Values.backup.s3bucket.bucketName }}"
          - name: APC_BACKUP_NS
            value: "{{ .Values.backup.apcBackupNs }}"
          volumeMounts:
            - name: init-scripts
              mountPath: /opt/vault-init
      volumes:
        - name: init-scripts
          configMap:
            name: {{ .Release.Name }}-init-scripts
            defaultMode: 0755
      restartPolicy: Never
{{- end }}
