apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: {{ include "application-gitops.fullname" . }}
  annotations:
    argocd.argoproj.io/sync-options: Replace=true
    policies.kyverno.io/title: Generate ArgoCD appproject, serviceaccount and rolebinding
    policies.kyverno.io/category: gitops
    policies.kyverno.io/subject: Generate application gitops resources
    policies.kyverno.io/minversion: 1.13.0
  labels:
    {{- include "application-gitops.labels" . | nindent 4 }}
spec:
  background: true
  validationFailureAction: Audit
  rules:
    - name: generate-argocd-appproject
      match:
        any:
          - resources:
              kinds:
                - argoproj.io/*/Application
              namespaceSelector:
                matchLabels:
                  apc.namespace.type: application
      preconditions:
        all:
        - key: {{`"{{ request.object.metadata.name }}"`}}
          operator: Equals
          value: {{`"{{ request.object.metadata.namespace }}"`}}
      generate:
        orphanDownstreamOnPolicyDelete: true
        synchronize: true
        generateExisting: true
        apiVersion: argoproj.io/v1alpha1
        kind: AppProject
        name: {{`"{{ request.object.metadata.namespace }}"`}}
        namespace: {{ .Values.gitopsNamespace }}
        data:
          spec:
            description: "{{`{{ request.object.metadata.namespace }}`}} namespace project"
            orphanedResources:
              warn: false
            # explicitly disable cluster resource access
            clusterResourceWhitelist: []
            # allow namespaced resources only using specific service account
            destinationServiceAccounts:
              - defaultServiceAccount: {{ include "application-gitops.fullname" . }}
                namespace: {{`"{{ request.object.metadata.namespace }}"`}}
                server: https://kubernetes.default.svc
            # allow deployment to current namespace only
            destinations:
            - namespace: {{`"{{ request.object.metadata.namespace }}"`}}
              # name: in-cluster
              server: https://kubernetes.default.svc
            # allow applications from current namespace only
            sourceNamespaces:
              - {{`"{{ request.object.metadata.namespace }}"`}}
            sourceRepos:
              - '{{ .Values.allowedGitDomain }}*'
            roles:
              {{- range $role, $roleValues := (include "application-gitops.roles" $ | fromJson ) }}
              {{- if $roleValues }}
              - description: "{{`{{ request.object.metadata.namespace }}`}} project {{ $role }} access"
                groups:
                  - APC-{{ include "application-gitops.environmentShort" $ | upper }}-{{`{{ to_upper(request.object.metadata.namespace) }}`}}-{{ $roleValues.groupSuffix }}
                name: {{ $role }}
                policies:
                {{- range $policy := $roleValues.policies }}
                  - p, proj:{{`{{ request.object.metadata.namespace }}`}}:{{ $role }}, {{ tpl $policy $ }}
                {{- end }}

              {{- end }}
              {{- end }}
    - name: generate-argocd-serviceaccount
      match:
        any:
          - resources:
              kinds:
                - argoproj.io/*/Application
              namespaceSelector:
                matchLabels:
                  apc.namespace.type: application
      preconditions:
        all:
        - key: {{`"{{ request.object.metadata.name }}"`}}
          operator: Equals
          value: {{`"{{ request.object.metadata.namespace }}"`}}
      generate:
        orphanDownstreamOnPolicyDelete: true
        # disable synchronize, or use server side apply = whole policy only!
        synchronize: false
        generateExisting: true
        apiVersion: v1
        kind: ServiceAccount
        name: {{ include "application-gitops.fullname" . }}
        namespace: {{`"{{ request.object.metadata.namespace }}"`}}
        data:
          metadata:
            # disabled sync doesn't delete downstream resource. Using ownerReference does the job
            ownerReferences:
            - apiVersion: {{`"{{request.object.apiVersion}}"`}}
              kind: {{`"{{request.object.kind}}"`}}
              name: {{`"{{request.object.metadata.name}}"`}}
              uid: {{`"{{request.object.metadata.uid}}"`}}

    - name: generate-argocd-rolebinding
      match:
        any:
          - resources:
              kinds:
                - argoproj.io/*/Application
              namespaceSelector:
                matchLabels:
                  apc.namespace.type: application
      preconditions:
        all:
        - key: {{`"{{ request.object.metadata.name }}"`}}
          operator: Equals
          value: {{`"{{ request.object.metadata.namespace }}"`}}
      generate:
        orphanDownstreamOnPolicyDelete: true
        synchronize: true
        generateExisting: true
        apiVersion: rbac.authorization.k8s.io/v1
        kind: RoleBinding
        name: {{ include "application-gitops.fullname" . }}
        namespace: {{`"{{ request.object.metadata.namespace }}"`}}
        data:
          # metadata:
          #   ownerReferences:
          #   - apiVersion: {{`"{{request.object.apiVersion}}"`}}
          #     kind: {{`"{{request.object.kind}}"`}}
          #     name: {{`"{{request.object.metadata.name}}"`}}
          #     uid: {{`"{{request.object.metadata.uid}}"`}}
          roleRef:
            apiGroup: rbac.authorization.k8s.io
            kind: ClusterRole
            name: {{ .Values.adminRole }}
          subjects:
          - kind: ServiceAccount
            name: {{ include "application-gitops.fullname" . }}
            namespace: {{`"{{ request.object.metadata.namespace }}"`}}
