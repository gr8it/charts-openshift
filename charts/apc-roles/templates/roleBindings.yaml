{{- $adGroupPrefix := .Values.adGroupPrefix }}
{{- $ldapGroupPrefix := .Values.ldapGroupPrefix }}
{{- $roleNamePrefix := .Values.roleNamePrefix }}
{{- $customerCode := .Values.customerCode }}
{{- range $idps, $groups := .Values.roleBindings }}
  {{- range $group, $roles := $groups }}
    {{- range $role, $ns := $roles }}
kind: RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  {{- if eq $idps "ad" }}
  name: {{ printf "%s_%s_%s-%s" $roleNamePrefix $group $customerCode $role | trunc 63 | trimSuffix "-" }}
  {{- else if eq $idps "ldap" }}
  name: {{ printf "%s_%s-%s" $roleNamePrefix $group $role | trunc 63 | trimSuffix "-" }}
  {{- end }}
  namespace: {{ $ns }}
  labels:
  {{- include "apc-roles.labels" $ | nindent 4 }}
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: {{ $role }}
subjects:
- apiGroup: rbac.authorization.k8s.io
  kind: Group
  {{- if eq $idps "ad" }}
  name: "{{ $adGroupPrefix }}-{{ include "apc-global-overrides.environmentShort" $ | upper }} {{ $group | upper }}"
  {{- else if eq $idps "ldap" }}
  name: {{ $ldapGroupPrefix }}_{{ $group }}_{{ include "apc-global-overrides.environment" $ }}
  {{- end }}
---
    {{- end}}
  {{- end }}
{{- end }}