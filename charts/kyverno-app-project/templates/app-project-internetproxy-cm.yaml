apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: app-project-internetproxy-cm
  labels:
  {{- include "kyverno-app-project.labels" . | nindent 4 }}
  annotations:
    policies.kyverno.io/title: Create configmap for internet proxy
    policies.kyverno.io/category: internetproxy 
    policies.kyverno.io/subject: project
    policies.kyverno.io/minversion: 1.13.0
spec:
  background: true
  generateExisting: true
  validationFailureAction: Audit
  rules:
    - name: app-project-internetproxy-cm
      match:
        any:
          - resources:
              kinds:
              - Namespace
      preconditions:
        all:
        - key: '{{ `{{ request.object.metadata.labels.\"apc.namespace.type\" }}` }}'
          operator: Equals
          value: application
      generate:
        apiVersion: v1
        kind: ConfigMap
        name: "proxy"
        namespace: '{{ `{{request.object.metadata.name}}` }}'
        synchronize: true
        data:
          kind: ConfigMap
          data:
            http_proxy: {{ .values.internetProxy.http_proxy }}
            https_proxy: {{ .values.internetProxy.https_proxy }}
            no_proxy: {{ .values.internetProxy.no_proxy }}
            HTTP_PROXY: {{ .values.internetProxy.http_proxy }}
            HTTPS_PROXY: {{ .values.internetProxy.https_proxy }}
            NO_PROXY: {{ .values.internetProxy.no_proxy }}